<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title><%= record ? "Edit Medical Record" : "Add Medical Record" %> - Pet Shelter Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/form.css">
</head>
<body>

    <%- include('partials/header') %>

    <div class="container mt-4">
        <h1><%= record ? "Edit Medical Record" : "Add New Medical Record" %></h1>

        <form action="<%= record ? '/medicalrecords/edit/' + record._id : '/medicalrecords/add' %>" method="POST">
            
            <div class="mb-3">
                <label for="record_id" class="form-label">Record ID</label>
                <input type="text" name="record_id" id="record_id" class="form-control" required
                    value="<%= record ? record.record_id : nextId %>" <%= record ? "readonly" : "" %>>
            </div>

            <div class="mb-3">
                <label for="pet_id" class="form-label">Pet</label>
                <select name="pet_id" id="pet_id" class="form-select" required>
                    <option value="">Select a Pet</option>
                    <% pets.forEach(p => { %>
                        <option value="<%= p.pet_id %>" <%= record && record.pet_id === p.pet_id ? "selected" : "" %>>
                            <%= p.name %> (<%= p.pet_id %>)
                        </option>
                    <% }) %>
                </select>
            </div>

            <div class="mb-3">
                <label for="type" class="form-label">Type</label>
                <select name="type" id="type" class="form-select" required>
                    <option value="">Select Type</option>
                    <option value="Vaccination" <%= record && record.type === "Vaccination" ? "selected" : "" %>>Vaccination</option>
                    <option value="Check-up" <%= record && record.type === "Check-up" ? "selected" : "" %>>Check-up</option>
                    <option value="Other" <%= record && record.type === "Other" ? "selected" : "" %>>Other</option>
                </select>
            </div>

            <!-- Vaccination field -->
            <div class="mb-3 dynamic-field" id="vaccinationField">
                <label for="vaccination_name" class="form-label">Vaccination Name</label>
                <input type="text" name="vaccination_name" id="vaccination_name" class="form-control"
                    value="<%= record ? record.vaccination_name || '' : '' %>">
            </div>

            <!-- Check-up fields -->
            <div class="mb-3 dynamic-field" id="checkupFields">
                <label for="diagnosis" class="form-label">Diagnosis</label>
                <input type="text" name="diagnosis" id="diagnosis" class="form-control"
                    value="<%= record ? record.diagnosis || '' : '' %>">
                
                <label for="treatment" class="form-label mt-2">Treatment</label>
                <input type="text" name="treatment" id="treatment" class="form-control"
                    value="<%= record ? record.treatment || '' : '' %>">
            </div>

            <!-- Notes (always visible) -->
            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <textarea name="notes" id="notes" class="form-control"><%= record ? record.notes : '' %></textarea>
            </div>

            <% if (record) { %>
                <!-- Edit button triggers modal -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmEditModal">
                    Update Record
                </button>
            <% } else { %>
                <!-- Add button submits directly -->
                <button type="submit" class="btn btn-primary">Add Record</button>
            <% } %>
            <a href="/medicalrecords" class="btn btn-secondary">Cancel</a>
        </form>
    </div>

    <% if (record) { %>
    <!-- Confirm Edit Modal -->
    <div class="modal fade" id="confirmEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Confirm Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to save these changes to this record?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmEditBtn">Yes, Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    <% } %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', () => {

            const typeSelect = document.getElementById('type');
            const vaccinationField = document.getElementById('vaccinationField');
            const checkupFields = document.getElementById('checkupFields');

            function toggleFields() {
                const type = typeSelect.value;
                vaccinationField.style.display = type === "Vaccination" ? "block" : "none";
                checkupFields.style.display = type === "Check-up" ? "block" : "none";
            }

            typeSelect.addEventListener('change', toggleFields);
            toggleFields(); // initialize on page load

            // Confirm Edit
            const confirmBtn = document.getElementById('confirmEditBtn');
            const form = document.querySelector('form');
            if (confirmBtn && form) {
                confirmBtn.addEventListener('click', () => {
                    form.submit();
                });
            }
        });
    </script>

</body>
</html>
